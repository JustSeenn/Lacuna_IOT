# Satellite coordinate
This flow contain 3 codes, each one need other to operate that's why there is in the same flow.

## Fill the DB 
We have to fill our database that records the satellite data here to launch the other applications when we receive data... 

## Find coordinate in live
It's the code on the left. It contain an HTTP request to recover data from "https://celestrak.com/satcat/tle.php?CATNR=44109".
We are using the plugin "satellite" from NodeRed to decode the TLE parameters.
And the plugin WorldMap to print it on the map at "http://localhost:1880/worldmap"

## Calculation of the distance 
We are calculating the distance between our satellite MP6 and our Sensors each time we received a packet from the satellite.
We use the "math" plugin to use the square root.


## Code 
    [{"id":"c4965cc0.7673a","type":"tab","label":"Coordonn√©es satellites 2","disabled":false,"info":""},{"id":"bde7d46c.301318","type":"http request","z":"c4965cc0.7673a","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"https://celestrak.com/satcat/tle.php?CATNR=44109","tls":"","persist":false,"proxy":"","authType":"","x":270,"y":140,"wires":[["5cafcf5c.41f4f"]]},{"id":"5cafcf5c.41f4f","type":"split","z":"c4965cc0.7673a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":250,"y":180,"wires":[["8cf83d13.ca251"]]},{"id":"37795dad.2af2f2","type":"tle","z":"c4965cc0.7673a","satid":"","tle1":"","tle2":"","coordsys":"latlongdeg","name":"MP6","x":250,"y":540,"wires":[["322aecb4.c66c54","bcbe6f0c.4863","d5024a00.ef8aa8"]]},{"id":"322aecb4.c66c54","type":"debug","z":"c4965cc0.7673a","name":"Message coming out of TLE node","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":500,"y":540,"wires":[]},{"id":"8cf83d13.ca251","type":"switch","z":"c4965cc0.7673a","name":"","property":"parts.index","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":250,"y":240,"wires":[["c5d936f6.5196f8"],["4a8f6e08.11f31"],["783fd9ef.5b4d68"],["908bb436.959798"]]},{"id":"c5d936f6.5196f8","type":"change","z":"c4965cc0.7673a","name":"","rules":[{"t":"set","p":"satid","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":300,"wires":[["f3a73982.3b8718"]]},{"id":"4a8f6e08.11f31","type":"change","z":"c4965cc0.7673a","name":"","rules":[{"t":"set","p":"tle1","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":340,"wires":[["f3a73982.3b8718"]]},{"id":"783fd9ef.5b4d68","type":"change","z":"c4965cc0.7673a","name":"","rules":[{"t":"set","p":"tle2","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":380,"wires":[["f3a73982.3b8718"]]},{"id":"f3a73982.3b8718","type":"join","z":"c4965cc0.7673a","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":250,"y":460,"wires":[["94b82f54.d9daf"]]},{"id":"908bb436.959798","type":"change","z":"c4965cc0.7673a","name":"set timestamp","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":420,"wires":[["f3a73982.3b8718"]]},{"id":"94b82f54.d9daf","type":"change","z":"c4965cc0.7673a","name":"put timestamp back in payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"timestamp","tot":"msg"},{"t":"delete","p":"timestamp","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":500,"wires":[["37795dad.2af2f2"]]},{"id":"bcbe6f0c.4863","type":"function","z":"c4965cc0.7673a","name":"","func":"msg.payload={\n    name : msg.payload.name,\n    lat : msg.payload.position.lat,\n    lon : msg.payload.position.lon,\n    alt : msg.payload.position.alt\n}\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":580,"wires":[["f9931da3.31008"]]},{"id":"f9931da3.31008","type":"worldmap","z":"c4965cc0.7673a","name":"","lat":"","lon":"","zoom":"","layer":"","cluster":"","maxage":"","usermenu":"show","layers":"show","panit":"false","panlock":"false","zoomlock":"false","hiderightclick":"false","coords":"false","showgrid":"false","path":"/worldmap","x":500,"y":580,"wires":[]},{"id":"d5024a00.ef8aa8","type":"function","z":"c4965cc0.7673a","name":"","func":"msg.payload ={\n        x : msg.payload.position.x,\n        y : msg.payload.position.y,\n        z : msg.payload.position.z,\n        lat : msg.payload.position.lat,\n        lon : msg.payload.position.lon,\n        alt : msg.payload.position.alt\n}\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":620,"wires":[["afc6600.76354a","fbf4fc12.338b4"]]},{"id":"afc6600.76354a","type":"influxdb out","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","measurement":"coo","precision":"","retentionPolicy":"","x":480,"y":620,"wires":[]},{"id":"fbf4fc12.338b4","type":"influxdb out","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","measurement":"dist","precision":"","retentionPolicy":"","x":480,"y":660,"wires":[]},{"id":"7e15412d.868e3","type":"complete","z":"c4965cc0.7673a","name":"","scope":["b4bfaf95.ad12b"],"uncaught":false,"x":270,"y":100,"wires":[["bde7d46c.301318"]]},{"id":"1eab06ac.7f62e9","type":"ttn uplink","z":"c4965cc0.7673a","name":"test","app":"89eee6e3.2d9ff8","dev_id":"test","field":"","x":450,"y":100,"wires":[["c8c680e0.1e9f5","b4bfaf95.ad12b"]]},{"id":"c8c680e0.1e9f5","type":"function","z":"c4965cc0.7673a","name":"","func":"var gatewaysarray = msg.metadata.gateways;\nvar rssi = [];\nvar logMsgs = [];\nvar moy;\n\nfor (i = 0; i < gatewaysarray.length; i++){\n    rssi[i]= gatewaysarray[i].rssi;}\n    moy = (rssi[0]+rssi[1])/2;\n\nmsg.payload ={\n       Accx : msg.payload.accx,\n       Accy : msg.payload.accy,\n       Accz : msg.payload.accz,\n       Humidity : msg.payload.humidity,\n       Lacuna_Sat : msg.payload.lacuna_sat,\n       Lat : msg.payload.lat,\n       Lon : msg.payload.lng,\n       Length : msg.payload.length,\n       Pressure : msg.payload.pressure,\n       Temp : msg.payload.temperature,\n       Tleage : msg.payload.tleage,\n       TTF : msg.payload.ttf,\n       Voltage : msg.payload.voltage,\n       Voltage_adc : msg.payload.voltage_adc,\n       Lacuna_sat : msg.payload.lacuna_sat,\n       RSSI : moy\n}\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":80,"wires":[["7d3f9557.27b0ac"]]},{"id":"7d3f9557.27b0ac","type":"influxdb out","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","measurement":"Test","precision":"","retentionPolicy":"","x":910,"y":80,"wires":[]},{"id":"b4bfaf95.ad12b","type":"function","z":"c4965cc0.7673a","name":"Complete","func":"var gatewaysarray = msg.metadata.gateways;\nvar rssi = [];\nvar logMsgs = [];\nvar moy;\n\nfor (i = 0; i < gatewaysarray.length; i++){\n    rssi[i]= gatewaysarray[i].rssi;}\n    moy = (rssi[0]+rssi[1])/2;\n\nmsg.payload ={\n        Accx : msg.payload.accx,\n        Accy : msg.payload.accy,\n        Accz : msg.payload.accz,\n        RSSI : moy\n}\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":140,"wires":[["bfb92226.ede6b"]]},{"id":"bfb92226.ede6b","type":"influxdb out","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","measurement":"dist","precision":"","retentionPolicy":"","x":900,"y":140,"wires":[]},{"id":"71f5703e.138d","type":"function","z":"c4965cc0.7673a","name":"Query","func":"msg.query = \"select * from dist order by time DESC limit 2\"\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":240,"wires":[["5f9604f6.830cbc"]]},{"id":"5f9604f6.830cbc","type":"influxdb in","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","query":"","rawOutput":false,"precision":"","retentionPolicy":"","x":510,"y":280,"wires":[["7e3448a1.302248"]]},{"id":"7e3448a1.302248","type":"function","z":"c4965cc0.7673a","name":"Calcul Distance","func":"var x2 = msg.payload[1].Accx;\nvar y2 = msg.payload[1].Accy;\nvar z2 = msg.payload[1].Accz;\nvar x1 = msg.payload[0].x;\nvar y1 = msg.payload[0].y;\nvar z1 = msg.payload[0].z;\nmsg.payload ={\n    Distance : (x1*x1-x2*x2)+(y1*y1-y2*y2)+(z1*z1-z2*z2),\n    x1 : x1,\n    y1 : y1,\n    z1 : z1,\n    x2 :x2\n}\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":320,"wires":[["8c57095c.5e5478"]]},{"id":"8c57095c.5e5478","type":"calculator","z":"c4965cc0.7673a","name":"","inputMsgField":"payload.Distance","outputMsgField":"payload.distance","operation":"sqrt","constant":"","x":510,"y":360,"wires":[["6dde5d40.0ced44"]]},{"id":"6dde5d40.0ced44","type":"debug","z":"c4965cc0.7673a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":510,"y":400,"wires":[]},{"id":"98a225ff.0fd3a8","type":"complete","z":"c4965cc0.7673a","name":"","scope":["d5024a00.ef8aa8"],"uncaught":false,"x":510,"y":200,"wires":[["71f5703e.138d"]]},{"id":"ac69b075.a9d24","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"Sensor_IOT","name":"Sensor_iOT","usetls":false,"tls":""},{"id":"89eee6e3.2d9ff8","type":"ttn app","z":"","appId":"ph0wn","accessKey":"ttn-account-v2.yTbE4m7S7rR7vDrRK7fEBtaL4GTN5ucffn02NT2VgC8","discovery":"discovery.thethingsnetwork.org:1900"}]
