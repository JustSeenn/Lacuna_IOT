# Satellite coordinate
This flow contain 3 codes, each one need other to operate that's why there is in the same flow.

## Fill the DB 
We have to fill our database that records the satellite data here to launch the other applications when we receive data... 

## Find coordinate in live
It's the code on the left. It contain an HTTP request to recover data from "https://celestrak.com/satcat/tle.php?CATNR=44109".
We are using the plugin "satellite" from NodeRed to decode the TLE parameters.
And the plugin WorldMap to print it on the map at "http://localhost:1880/worldmap"

## Calculation of the distance 
We are calculating the distance between our satellite MP6 and our Sensors each time we received a packet from the satellite.
We use the "math" plugin to use the square root.


## Code 
    [{"id":"c4965cc0.7673a","type":"tab","label":"Coordonn√©es satellites 2","disabled":false,"info":""},{"id":"bde7d46c.301318","type":"http request","z":"c4965cc0.7673a","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"https://celestrak.com/satcat/tle.php?CATNR=44109","tls":"","persist":false,"proxy":"","authType":"","x":270,"y":140,"wires":[["5cafcf5c.41f4f"]]},{"id":"5cafcf5c.41f4f","type":"split","z":"c4965cc0.7673a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":250,"y":180,"wires":[["8cf83d13.ca251"]]},{"id":"37795dad.2af2f2","type":"tle","z":"c4965cc0.7673a","satid":"","tle1":"","tle2":"","coordsys":"latlongdeg","name":"MP6","x":250,"y":540,"wires":[["322aecb4.c66c54","bcbe6f0c.4863","d5024a00.ef8aa8"]]},{"id":"322aecb4.c66c54","type":"debug","z":"c4965cc0.7673a","name":"Message coming out of TLE node","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":500,"y":540,"wires":[]},{"id":"8cf83d13.ca251","type":"switch","z":"c4965cc0.7673a","name":"","property":"parts.index","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":4,"x":250,"y":240,"wires":[["c5d936f6.5196f8"],["4a8f6e08.11f31"],["783fd9ef.5b4d68"],["908bb436.959798"]]},{"id":"c5d936f6.5196f8","type":"change","z":"c4965cc0.7673a","name":"","rules":[{"t":"set","p":"satid","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":300,"wires":[["f3a73982.3b8718"]]},{"id":"4a8f6e08.11f31","type":"change","z":"c4965cc0.7673a","name":"","rules":[{"t":"set","p":"tle1","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":340,"wires":[["f3a73982.3b8718"]]},{"id":"783fd9ef.5b4d68","type":"change","z":"c4965cc0.7673a","name":"","rules":[{"t":"set","p":"tle2","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":380,"wires":[["f3a73982.3b8718"]]},{"id":"f3a73982.3b8718","type":"join","z":"c4965cc0.7673a","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":250,"y":460,"wires":[["94b82f54.d9daf"]]},{"id":"908bb436.959798","type":"change","z":"c4965cc0.7673a","name":"set timestamp","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":420,"wires":[["f3a73982.3b8718"]]},{"id":"94b82f54.d9daf","type":"change","z":"c4965cc0.7673a","name":"put timestamp back in payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"timestamp","tot":"msg"},{"t":"delete","p":"timestamp","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":500,"wires":[["37795dad.2af2f2"]]},{"id":"bcbe6f0c.4863","type":"function","z":"c4965cc0.7673a","name":"","func":"msg.payload={\n    name : msg.payload.name,\n    lat : msg.payload.position.lat,\n    lon : msg.payload.position.lon,\n    alt : msg.payload.position.alt,\n    label : \"Lastest position\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":580,"wires":[["f9931da3.31008"]]},{"id":"f9931da3.31008","type":"worldmap","z":"c4965cc0.7673a","name":"","lat":"","lon":"","zoom":"","layer":"","cluster":"","maxage":"","usermenu":"show","layers":"show","panit":"false","panlock":"false","zoomlock":"false","hiderightclick":"false","coords":"none","showgrid":"false","path":"/worldmap","x":440,"y":640,"wires":[]},{"id":"d5024a00.ef8aa8","type":"function","z":"c4965cc0.7673a","name":"","func":"\nmsg.payload ={\n        x : msg.payload.position.x,\n        y : msg.payload.position.y,\n        z : msg.payload.position.z,\n        lat : msg.payload.position.lat,\n        lon : msg.payload.position.lon,\n        alt : msg.payload.position.alt,\n        \n}\nmsg.complete = true;\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":640,"wires":[["fbf4fc12.338b4","98afa985.2f3218"]]},{"id":"afc6600.76354a","type":"influxdb out","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","measurement":"coo","precision":"","retentionPolicy":"","x":1140,"y":720,"wires":[]},{"id":"fbf4fc12.338b4","type":"influxdb out","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","measurement":"dist","precision":"","retentionPolicy":"","x":620,"y":720,"wires":[]},{"id":"7e15412d.868e3","type":"complete","z":"c4965cc0.7673a","name":"","scope":["b4bfaf95.ad12b"],"uncaught":false,"x":270,"y":100,"wires":[["bde7d46c.301318"]]},{"id":"1eab06ac.7f62e9","type":"ttn uplink","z":"c4965cc0.7673a","name":"test","app":"89eee6e3.2d9ff8","dev_id":"test","field":"","x":650,"y":100,"wires":[["c8c680e0.1e9f5","b4bfaf95.ad12b","4d4095cf.ba4e4c"]]},{"id":"c8c680e0.1e9f5","type":"function","z":"c4965cc0.7673a","name":"","func":"var gatewaysarray = msg.metadata.gateways;\nvar rssi = [];\nvar logMsgs = [];\nvar moy;\n\nfor (i = 0; i < gatewaysarray.length; i++){\n    rssi[i]= gatewaysarray[i].rssi;}\n    moy = (rssi[0]+rssi[1])/2;\n\nmsg.payload ={\n       Accx : msg.payload.accx,\n       Accy : msg.payload.accy,\n       Accz : msg.payload.accz,\n       Humidity : msg.payload.humidity,\n       Lacuna_Sat : msg.payload.lacuna_sat,\n       Lat : msg.payload.lat,\n       Lon : msg.payload.lng,\n       Length : msg.payload.length,\n       Pressure : msg.payload.pressure,\n       Temp : msg.payload.temperature,\n       Tleage : msg.payload.tleage,\n       TTF : msg.payload.ttf,\n       Voltage : msg.payload.voltage,\n       Voltage_adc : msg.payload.voltage_adc,\n       Lacuna_sat : msg.payload.lacuna_sat,\n       RSSI : moy\n}\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":80,"wires":[["7d3f9557.27b0ac"]]},{"id":"7d3f9557.27b0ac","type":"influxdb out","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","measurement":"Test","precision":"","retentionPolicy":"","x":1110,"y":80,"wires":[]},{"id":"b4bfaf95.ad12b","type":"function","z":"c4965cc0.7673a","name":"Complete","func":"var gatewaysarray = msg.metadata.gateways;\nvar rssi = [];\nvar logMsgs = [];\nvar moy;\n\nfor (i = 0; i < gatewaysarray.length; i++){\n    rssi[i]= gatewaysarray[i].rssi;}\n    moy = (rssi[0]+rssi[1])/2;\n\n\n\nmsg.payload ={\n        Accx : msg.payload.accx,\n        Accy : msg.payload.accy,\n        Accz : msg.payload.accz,\n        RSSI : moy\n}\nreturn msg;","outputs":1,"noerr":0,"x":820,"y":140,"wires":[["bfb92226.ede6b"]]},{"id":"bfb92226.ede6b","type":"influxdb out","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","measurement":"dist","precision":"","retentionPolicy":"","x":1100,"y":140,"wires":[]},{"id":"71f5703e.138d","type":"function","z":"c4965cc0.7673a","name":"Query","func":"msg.query = \"select * from dist order by time DESC limit 2\"\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":240,"wires":[["5f9604f6.830cbc"]]},{"id":"5f9604f6.830cbc","type":"influxdb in","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","query":"","rawOutput":false,"precision":"","retentionPolicy":"","x":510,"y":280,"wires":[["7e3448a1.302248"]]},{"id":"7e3448a1.302248","type":"function","z":"c4965cc0.7673a","name":"Calcul Distance","func":"var x2 = msg.payload[1].Accx;\nvar y2 = msg.payload[1].Accy;\nvar z2 = msg.payload[1].Accz;\nvar x1 = msg.payload[0].x;\nvar y1 = msg.payload[0].y;\nvar z1 = msg.payload[0].z;\nmsg.payload ={\n    Distance : (x1*x1-x2*x2)+(y1*y1-y2*y2)+(z1*z1-z2*z2),\n    x1 : x1,\n    y1 : y1,\n    z1 : z1,\n    x2 :x2\n}\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":320,"wires":[["8c57095c.5e5478"]]},{"id":"8c57095c.5e5478","type":"calculator","z":"c4965cc0.7673a","name":"","inputMsgField":"payload.Distance","outputMsgField":"payload.Distance","operation":"sqrt","constant":"","x":510,"y":360,"wires":[["6dde5d40.0ced44","98afa985.2f3218"]]},{"id":"6dde5d40.0ced44","type":"debug","z":"c4965cc0.7673a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":510,"y":400,"wires":[]},{"id":"98a225ff.0fd3a8","type":"complete","z":"c4965cc0.7673a","name":"","scope":["d5024a00.ef8aa8"],"uncaught":false,"x":510,"y":200,"wires":[["71f5703e.138d"]]},{"id":"87187e0d.bf4","type":"inject","z":"c4965cc0.7673a","name":"","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":60,"wires":[[]]},{"id":"7d515bc4.690934","type":"function","z":"c4965cc0.7673a","name":"Compute device List","func":"msg.payload = {};\nif(msg.index<msg.toto.length)\n{\n    msg.query=\"select * from coo where lat = \" +msg.toto[msg.index].lat+ \"order by time DESC limit 1\"\n    msg.index = msg.index+1;\n    return msg;\n}\n","outputs":1,"noerr":0,"x":460,"y":960,"wires":[["939eb3a7.3d2a6"]]},{"id":"939eb3a7.3d2a6","type":"influxdb in","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","query":"","rawOutput":false,"precision":"","retentionPolicy":"","x":650,"y":960,"wires":[["64ca4914.a6e218"]]},{"id":"64ca4914.a6e218","type":"switch","z":"c4965cc0.7673a","name":"","property":"payload[0]","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":1060,"wires":[["7d515bc4.690934"],["8dfebaf5.c67928"]]},{"id":"8dfebaf5.c67928","type":"function","z":"c4965cc0.7673a","name":"","func":"var iconColor;\nvar Command\nif(msg.payload[0].RSSI<=-82){\n    iconColor = \"red\";\n}\nelse if(msg.payload[0].RSSI<=-80)\n{\n    iconColor = \"orange\";\n}\nelse if(msg.payload[0].RSSI<=-78){\n    iconColor = \"purple\";\n}else {\n        iconColor = \"blue\";\n\n}\n\nmsg.payload ={\n    name : \"M6P\"+ msg.index,\n    lat : msg.payload[0].lat,\n    lon : msg.payload[0].lon,\n    label : \"\"+msg.index,\n    RSSi : msg.payload[0].RSSI,\n    iconColor : iconColor,\n    Distance : msg.payload[0].Distance,\n    layer : \"drawing\",\n    line : [[43.716372, 7.126737] , [msg.payload[0].lat,msg.payload[0].lon]]\n}\nreturn msg;\n\n\n","outputs":1,"noerr":0,"x":850,"y":1060,"wires":[["7d515bc4.690934","4c12f7c6.407a78","1300a1fd.7c7a5e"]]},{"id":"b6dc387d.44fdc8","type":"inject","z":"c4965cc0.7673a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":920,"wires":[["d7be1ec8.a2eae"]]},{"id":"d7be1ec8.a2eae","type":"function","z":"c4965cc0.7673a","name":"SQL select","func":"\nmsg.query =\"select * from coo\"\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":920,"wires":[["7451e9cb.c775e8"]]},{"id":"7451e9cb.c775e8","type":"influxdb in","z":"c4965cc0.7673a","influxdb":"ac69b075.a9d24","name":"","query":"","rawOutput":false,"precision":"","retentionPolicy":"","x":650,"y":920,"wires":[["70d5abfb.b7d3e4"]]},{"id":"70d5abfb.b7d3e4","type":"function","z":"c4965cc0.7673a","name":"","func":"msg.index=0;\nmsg.toto=msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":920,"wires":[["7d515bc4.690934"]]},{"id":"4d4095cf.ba4e4c","type":"function","z":"c4965cc0.7673a","name":"","func":"var gatewaysarray = msg.metadata.gateways;\nvar rssi = [];\nvar logMsgs = [];\nvar moy;\n\nfor (i = 0; i < gatewaysarray.length; i++){\n    rssi[i]= gatewaysarray[i].rssi;}\n    moy = (rssi[0]+rssi[1])/2;\n\n\n\nmsg.payload ={\n        RSSI : moy,\n       \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":560,"wires":[["98afa985.2f3218"]]},{"id":"98afa985.2f3218","type":"join","z":"c4965cc0.7673a","name":"","mode":"custom","build":"merged","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"10s","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1170,"y":600,"wires":[["afc6600.76354a","c36fa5a7.515558"]]},{"id":"4c12f7c6.407a78","type":"debug","z":"c4965cc0.7673a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1200,"y":1000,"wires":[]},{"id":"1300a1fd.7c7a5e","type":"worldmap","z":"c4965cc0.7673a","name":"","lat":"","lon":"","zoom":"","layer":"","cluster":"","maxage":"","usermenu":"show","layers":"show","panit":"false","panlock":"false","zoomlock":"false","hiderightclick":"false","coords":"false","showgrid":"false","path":"/worldmap","x":1240,"y":1080,"wires":[]},{"id":"c36fa5a7.515558","type":"debug","z":"c4965cc0.7673a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1340,"y":720,"wires":[]},{"id":"ac69b075.a9d24","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"Sensor_IOT","name":"Sensor_iOT","usetls":false,"tls":""},{"id":"89eee6e3.2d9ff8","type":"ttn app","z":"","appId":"ph0wn","accessKey":"ttn-account-v2.yTbE4m7S7rR7vDrRK7fEBtaL4GTN5ucffn02NT2VgC8","discovery":"discovery.thethingsnetwork.org:1900"}]
